services:
  # ─────────────────────────────────────────
  # Nginx
  # ─────────────────────────────────────────
  nginx:
    image: nginx:1.27-alpine
    container_name: ${COMPOSE_PROJECT_NAME}-nginx
    ports:
      - "80:80"
    depends_on:
      - was1
      - was2
    volumes:
      - ./docker/nginx.conf:/etc/nginx/nginx.conf:ro
    networks:
      - app-net
    restart: unless-stopped

  # ─────────────────────────────────────────
  # WAS 1
  # ─────────────────────────────────────────
  was1:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ${COMPOSE_PROJECT_NAME}-was1
    ports:
      - "8080:8080"
    environment:
      DB_NAME: ${APP_DB_NAME}
      DB_SOURCE_HOST: mysql-router
      DB_SOURCE_PORT: 6446
      DB_SOURCE_USER: ${APP_DB_USER}
      DB_SOURCE_PASSWORD: ${APP_DB_PASSWORD}
      DB_REPLICA_HOST: mysql-router
      DB_REPLICA_PORT: 6447
      DB_REPLICA_USER: ${APP_DB_RO_USER}
      DB_REPLICA_PASSWORD: ${APP_DB_RO_PASSWORD}
      DB_PARAMS: serverTimezone=Asia/Seoul&characterEncoding=UTF-8&useSSL=false&allowPublicKeyRetrieval=true
    depends_on:
      mysql-router:
        condition: service_healthy
    networks:
      - app-net
    restart: unless-stopped

  # ─────────────────────────────────────────
  # WAS 2
  # ─────────────────────────────────────────
  was2:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ${COMPOSE_PROJECT_NAME}-was2
    ports:
      - "8090:8080"
    environment:
      DB_NAME: ${APP_DB_NAME}
      DB_SOURCE_HOST: mysql-router
      DB_SOURCE_PORT: 6446
      DB_SOURCE_USER: ${APP_DB_USER}
      DB_SOURCE_PASSWORD: ${APP_DB_PASSWORD}
      DB_REPLICA_HOST: mysql-router
      DB_REPLICA_PORT: 6447
      DB_REPLICA_USER: ${APP_DB_RO_USER}
      DB_REPLICA_PASSWORD: ${APP_DB_RO_PASSWORD}
      DB_PARAMS: serverTimezone=Asia/Seoul&characterEncoding=UTF-8&useSSL=false&allowPublicKeyRetrieval=true
    depends_on:
      mysql-router:
        condition: service_healthy
    networks:
      - app-net
    restart: unless-stopped

  # ─────────────────────────────────────────
  # MySQL Node 1
  # ─────────────────────────────────────────
  mysql1:
    image: mysql:8.0
    container_name: ${COMPOSE_PROJECT_NAME}-mysql1
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
    volumes:
      - mysql1_data:/var/lib/mysql
      - ./docker/mysql/innodb/mysql1/my.cnf:/etc/mysql/conf.d/my.cnf:ro
      - ./docker/mysql/init:/docker-entrypoint-initdb.d:ro
    expose:
      - "3306"
      - "33061"
    networks:
      - app-net
    restart: unless-stopped

  mysql2:
    image: mysql:8.0
    container_name: ${COMPOSE_PROJECT_NAME}-mysql2
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
    volumes:
      - mysql2_data:/var/lib/mysql
      - ./docker/mysql/innodb/mysql2/my.cnf:/etc/mysql/conf.d/my.cnf:ro
      - ./docker/mysql/init:/docker-entrypoint-initdb.d:ro
    expose:
      - "3306"
      - "33061"
    networks:
      - app-net
    restart: unless-stopped

  mysql3:
    image: mysql:8.0
    container_name: ${COMPOSE_PROJECT_NAME}-mysql3
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
    volumes:
      - mysql3_data:/var/lib/mysql
      - ./docker/mysql/innodb/mysql3/my.cnf:/etc/mysql/conf.d/my.cnf:ro
      - ./docker/mysql/init:/docker-entrypoint-initdb.d:ro
    expose:
      - "3306"
      - "33061"
    networks:
      - app-net
    restart: unless-stopped

  mysql4:
    image: mysql:8.0
    container_name: ${COMPOSE_PROJECT_NAME}-mysql4
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
    volumes:
      - mysql4_data:/var/lib/mysql
      - ./docker/mysql/innodb/mysql4/my.cnf:/etc/mysql/conf.d/my.cnf:ro
      - ./docker/mysql/init:/docker-entrypoint-initdb.d:ro
    expose:
      - "3306"
      - "33061"
    networks:
      - app-net
    restart: unless-stopped

  # ─────────────────────────────────────────
  # MySQL Shell
  # ─────────────────────────────────────────
  mysqlsh:
    image: mysql/mysql-server:8.0
    container_name: ${COMPOSE_PROJECT_NAME}-mysqlsh
    entrypoint:
      - /bin/bash
      - -c
      - |
        echo "[mysqlsh] Waiting for mysql1 to be ready..."
        until mysqlsh root:1234@mysql1:3306 -e "print('ok')" 2>/dev/null; do
          sleep 5
        done
        echo "[mysqlsh] Attempting cluster recovery..."
        mysqlsh root:1234@mysql1:3306 -e "dba.rebootClusterFromCompleteOutage()" 2>/dev/null || true
        echo "[mysqlsh] Done. Sleeping..."
        sleep infinity
    depends_on:
      - mysql1
      - mysql2
      - mysql3
      - mysql4
    networks:
      - app-net
    restart: unless-stopped

  # ─────────────────────────────────────────
  # MySQL Router
  # ─────────────────────────────────────────
  mysql-router:
    image: mysql/mysql-router:8.0
    container_name: ${COMPOSE_PROJECT_NAME}-mysql-router
    user: "0:0"
    entrypoint:
      - /bin/bash
      - -c
      - |
        CONF=/router/mysqlrouter.conf
        if [ ! -f "$$CONF" ]; then
          echo "[router] Config not found. Waiting for bootstrap..."
          while [ ! -f "$$CONF" ]; do sleep 5; done
        fi
        echo "[router] Starting mysqlrouter..."
        exec mysqlrouter -c "$$CONF"
    volumes:
      - mysqlrouter_data:/router
    ports:
      - "6446:6446"
      - "6447:6447"
    depends_on:
      - mysql1
    networks:
      - app-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "bash -lc 'echo > /dev/tcp/127.0.0.1/6446'"]
      interval: 5s
      timeout: 3s
      retries: 20

networks:
  app-net:
    driver: bridge

volumes:
  mysql1_data:
  mysql2_data:
  mysql3_data:
  mysql4_data:
  mysqlrouter_data:
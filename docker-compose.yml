services:

  # ─────────────────────────────────────────
  # Nginx
  # ─────────────────────────────────────────
  nginx:
    image: nginx:1.27-alpine
    container_name: ${COMPOSE_PROJECT_NAME}-nginx
    ports:
      - "80:80"
    depends_on:
      - was1
      - was2
    volumes:
      - ./docker/nginx.conf:/etc/nginx/nginx.conf:ro
    networks:
      - app-net
    restart: unless-stopped


  # ─────────────────────────────────────────
  # WAS 1
  # ─────────────────────────────────────────
  was1:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ${COMPOSE_PROJECT_NAME}-was1
    ports:
      - "8080:8080"
    environment:
      DB_NAME: ${APP_DB_NAME}

      DB_SOURCE_HOST: mysql-router
      DB_SOURCE_PORT: 6446
      DB_SOURCE_USER: ${APP_DB_USER}
      DB_SOURCE_PASSWORD: ${APP_DB_PASSWORD}

      DB_REPLICA_HOST: mysql-router
      DB_REPLICA_PORT: 6447
      DB_REPLICA_USER: ${APP_DB_RO_USER}
      DB_REPLICA_PASSWORD: ${APP_DB_RO_PASSWORD}

      DB_PARAMS: serverTimezone=Asia/Seoul&characterEncoding=UTF-8&useSSL=false&allowPublicKeyRetrieval=true
    depends_on:
      - mysql-router
    networks:
      - app-net
    restart: unless-stopped


  # ─────────────────────────────────────────
  # WAS 2
  # ─────────────────────────────────────────
  was2:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ${COMPOSE_PROJECT_NAME}-was2
    ports:
      - "8090:8080"
    environment:
      DB_NAME: ${APP_DB_NAME}

      DB_SOURCE_HOST: mysql-router
      DB_SOURCE_PORT: 6446
      DB_SOURCE_USER: ${APP_DB_USER}
      DB_SOURCE_PASSWORD: ${APP_DB_PASSWORD}

      DB_REPLICA_HOST: mysql-router
      DB_REPLICA_PORT: 6447
      DB_REPLICA_USER: ${APP_DB_RO_USER}
      DB_REPLICA_PASSWORD: ${APP_DB_RO_PASSWORD}

      DB_PARAMS: serverTimezone=Asia/Seoul&characterEncoding=UTF-8&useSSL=false&allowPublicKeyRetrieval=true
    depends_on:
      - mysql-router
    networks:
      - app-net
    restart: unless-stopped


  # ─────────────────────────────────────────
  # MySQL Node 1 (bootstrap_group=ON)
  # ─────────────────────────────────────────
  mysql1:
    image: mysql:8.0
    container_name: ${COMPOSE_PROJECT_NAME}-mysql1
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
    volumes:
      - mysql1_data:/var/lib/mysql
      - ./docker/mysql/innodb/mysql1/my.cnf:/etc/mysql/conf.d/my.cnf:ro
      - ./docker/mysql/init:/docker-entrypoint-initdb.d:ro
    expose:
      - "3306"
      - "33061"
    networks:
      - app-net
    restart: unless-stopped


  mysql2:
    image: mysql:8.0
    container_name: ${COMPOSE_PROJECT_NAME}-mysql2
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
    volumes:
      - mysql2_data:/var/lib/mysql
      - ./docker/mysql/innodb/mysql2/my.cnf:/etc/mysql/conf.d/my.cnf:ro
      - ./docker/mysql/init:/docker-entrypoint-initdb.d:ro
    expose:
      - "3306"
      - "33061"
    networks:
      - app-net
    restart: unless-stopped


  mysql3:
    image: mysql:8.0
    container_name: ${COMPOSE_PROJECT_NAME}-mysql3
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
    volumes:
      - mysql3_data:/var/lib/mysql
      - ./docker/mysql/innodb/mysql3/my.cnf:/etc/mysql/conf.d/my.cnf:ro
      - ./docker/mysql/init:/docker-entrypoint-initdb.d:ro
    expose:
      - "3306"
      - "33061"
    networks:
      - app-net
    restart: unless-stopped


  mysql4:
    image: mysql:8.0
    container_name: ${COMPOSE_PROJECT_NAME}-mysql4
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
    volumes:
      - mysql4_data:/var/lib/mysql
      - ./docker/mysql/innodb/mysql4/my.cnf:/etc/mysql/conf.d/my.cnf:ro
      - ./docker/mysql/init:/docker-entrypoint-initdb.d:ro
    expose:
      - "3306"
      - "33061"
    networks:
      - app-net
    restart: unless-stopped


  # ─────────────────────────────────────────
  # MySQL Shell (Cluster 구성용)
  # ─────────────────────────────────────────
  mysqlsh:
    image: mysql/mysql-server:8.0
    container_name: ${COMPOSE_PROJECT_NAME}-mysqlsh
    entrypoint: ["sleep", "infinity"]
    depends_on:
      - mysql1
      - mysql2
      - mysql3
      - mysql4
    networks:
      - app-net
    restart: unless-stopped


  # ─────────────────────────────────────────
  # MySQL Router
  #   - 설정 파일 없으면 대기 (최초 부트스트랩 전)
  #   - 설정 파일 있으면 자동 시작
  # ─────────────────────────────────────────
  mysql-router:
    image: mysql/mysql-router:8.0
    container_name: ${COMPOSE_PROJECT_NAME}-mysql-router
    user: "0:0"
    entrypoint:
      - /bin/bash
      - -c
      - |
        CONF=/router/mysqlrouter.conf
        if [ ! -f "$$CONF" ]; then
          echo "[router] Config not found. Waiting for bootstrap..."
          while [ ! -f "$$CONF" ]; do sleep 5; done
        fi
        echo "[router] Config found. Starting mysqlrouter..."
        exec mysqlrouter -c "$$CONF"
    volumes:
      - mysqlrouter_data:/router
    ports:
      - "6446:6446"
      - "6447:6447"
    depends_on:
      - mysql1
    networks:
      - app-net
    restart: unless-stopped


networks:
  app-net:
    driver: bridge


volumes:
  mysql1_data:
  mysql2_data:
  mysql3_data:
  mysql4_data:
  mysqlrouter_data:
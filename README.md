<img width="901" height="302" alt="woori-card-scope drawio (1)" src="https://github.com/user-attachments/assets/5a7be9ed-ca9c-4df5-ae02-b77a84d1b94f" />

# ë°ì´í„°ë² ì´ìŠ¤ ì„¤ê³„

## **1. InnoDB Cluster êµ¬ì„±**

ë³¸ í”„ë¡œì íŠ¸ëŠ” **MySQL InnoDB Cluster** ê¸°ë°˜ìœ¼ë¡œ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ êµ¬ì„±í•˜ì—¬ ë‹¤ìŒì„ ë‹¬ì„±í–ˆìŠµë‹ˆë‹¤.

- **ê³ ê°€ìš©ì„±(High Availability, HA)**
    
    â†’ íŠ¹ì • DB ì¸ìŠ¤í„´ìŠ¤ì— ì¥ì• ê°€ ë°œìƒí•´ë„ ì„œë¹„ìŠ¤ ì§€ì† ê°€ëŠ¥
    
- **ì½ê¸° íŠ¸ë˜í”½ ë¶„ì‚°(Scale-out)**
    
    â†’ Secondary ë…¸ë“œë¥¼ í™œìš©í•œ ì¡°íšŒ ë¶€í•˜ ë¶„ì‚°
    
- **ìë™ ì¥ì• ì¡°ì¹˜(Failover)**
    
    â†’ Primary ì¥ì•  ë°œìƒ ì‹œ ìë™ìœ¼ë¡œ ë‹¤ë¥¸ ë…¸ë“œê°€ ìŠ¹ê²©
    

---

### **1-1. ê¸°ë³¸ êµ¬ì„±**

### **â‘  MySQL Server 4ëŒ€ (mysql1 ~ mysql4)**

- ì´ 4ê°œì˜ MySQL ì¸ìŠ¤í„´ìŠ¤ë¥¼ í•˜ë‚˜ì˜ í´ëŸ¬ìŠ¤í„°ë¡œ êµ¬ì„±
- êµ¬ì„± ë°©ì‹: **Single-Primary ëª¨ë“œ**
    - 1ëŒ€ â†’ **Primary (R/W)**
    - 3ëŒ€ â†’ **Secondary (R/O)**

> Secondaryë¥¼ 3ëŒ€ë¡œ êµ¬ì„±í•˜ì—¬
> 
- ì½ê¸° ë¶€í•˜ ë¶„ì‚° ì—¬ìœ  í™•ë³´
- Primary ì¥ì•  ì‹œ ìŠ¹ê²© í›„ë³´ í™•ë³´
- 1ëŒ€ ì¥ì• ê¹Œì§€ ì•ˆì •ì  ìš´ì˜ ê°€ëŠ¥

---

### **â‘¡ Group Replication (í•µì‹¬ ì—”ì§„)**

Group Replicationì€ ë‹¤ìŒ ê¸°ëŠ¥ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.

- Primaryì—ì„œ ë°œìƒí•œ íŠ¸ëœì­ì…˜ì„ Secondaryë¡œ ë³µì œ
- í´ëŸ¬ìŠ¤í„° ë©¤ë²„ì‹­ ê´€ë¦¬
- ì¥ì•  ê°ì§€
- Primary ìë™ ì¬ì„ ì¶œ (Failover)
- íŠ¸ëœì­ì…˜ ì»¤ë°‹ ì „ **í•©ì˜(Consensus)** ìˆ˜í–‰

ì¦‰, ë‹¨ìˆœ ë³µì œê°€ ì•„ë‹ˆë¼

**í•©ì˜ ê¸°ë°˜ ê³ ê°€ìš©ì„± ë³µì œ ì‹œìŠ¤í…œ**ì…ë‹ˆë‹¤.

---

### **â‘¢ MySQL Shell (AdminAPI)**

MySQL Shellì˜ AdminAPIë¥¼ ì‚¬ìš©í•˜ì—¬ í´ëŸ¬ìŠ¤í„°ë¥¼ êµ¬ì„±í–ˆìŠµë‹ˆë‹¤.

- dba.createCluster() â†’ í´ëŸ¬ìŠ¤í„° ìƒì„±
- cluster.addInstance() â†’ ì¸ìŠ¤í„´ìŠ¤ ì¶”ê°€
- cluster.status() â†’ ìƒíƒœ ì¡°íšŒ

ì´ë¥¼ í†µí•´ ìˆ˜ë™ ì„¤ì • ì—†ì´ ìë™í™”ëœ í´ëŸ¬ìŠ¤í„° êµ¬ì„±ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.

---

### **â‘£ MySQL Router (R/W ë¶„ë¦¬)**

MySQL Routerë¥¼ ì‚¬ìš©í•˜ì—¬ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ DB í† í´ë¡œì§€ë¥¼ ì¸ì§€í•˜ì§€ ì•Šë„ë¡ êµ¬ì„±í–ˆìŠµë‹ˆë‹¤.

| **í¬íŠ¸** | **ì—­í• ** |
| --- | --- |
| **6446** | Read/Write â†’ í•­ìƒ í˜„ì¬ Primary |
| **6447** | Read Only â†’ Secondaryë¡œ ë¶„ì‚° |

ì• í”Œë¦¬ì¼€ì´ì…˜ì€ Routerì—ë§Œ ì—°ê²°í•˜ë©°,
Primary ë³€ê²½ ì‹œì—ë„ **ì½”ë“œ ìˆ˜ì • ì—†ì´ ìë™ ë°˜ì˜**ë©ë‹ˆë‹¤.

---

## **ğŸ—³ 2. Voting(Quorum)ê³¼ Primary ìŠ¹ê²©**

### **2-1. Quorum (ê³¼ë°˜ìˆ˜ ì›ì¹™)**

Group Replicationì€ **ê³¼ë°˜ìˆ˜(majority) ê¸°ë°˜ í•©ì˜ ì‹œìŠ¤í…œ**ì…ë‹ˆë‹¤.

### **Quorum ê³µì‹**

```java
Quorum = âŒŠN / 2âŒ‹ + 1
```

ë³¸ í”„ë¡œì íŠ¸ êµ¬ì„±:

```java
N = 4
Quorum = 3
```

ì¦‰,

- ìµœì†Œ **3ëŒ€ê°€ ì‚´ì•„ ìˆì–´ì•¼ ì •ìƒ ë™ì‘**
- 1ëŒ€ ì¥ì• ê¹Œì§€ëŠ” ìë™ ë³µêµ¬ ê°€ëŠ¥
- 2ëŒ€ ì´ìƒ ì¥ì•  ì‹œ Quorum ë¶•ê´´ â†’ ì“°ê¸° ì°¨ë‹¨ ê°€ëŠ¥

ì´ëŠ” **Split-Brain ë°©ì§€**ë¥¼ ìœ„í•œ ì„¤ê³„ì…ë‹ˆë‹¤.

---

### **2-2. Primary ì„ ì¶œ ê·œì¹™**

Single-Primary ëª¨ë“œì—ì„œ Primary ì¥ì•  ë°œìƒ ì‹œ ë‹¤ìŒ ê¸°ì¤€ìœ¼ë¡œ ìŠ¹ê²©ë©ë‹ˆë‹¤.

1. group_replication_member_weight ê°’ì´ ë†’ì€ ì¸ìŠ¤í„´ìŠ¤ ìš°ì„ 
2. ë™ì¼í•  ê²½ìš° server_uuidê°€ ê°€ì¥ ë‚®ì€ ì¸ìŠ¤í„´ìŠ¤ ì„ íƒ
3. ìˆ˜ë™ ì§€ì •ë„ ê°€ëŠ¥ (group_replication_set_as_primary)

> ìŠ¹ê²©ì€ ëœë¤ì´ ì•„ë‹Œ, **ê²°ì •ì  ê·œì¹™ ê¸°ë°˜**
> 

---

### **2-3. í•©ì˜ ì•Œê³ ë¦¬ì¦˜ (XCom, Paxos Variant)**

Group Replicationì€ ë‚´ë¶€ì ìœ¼ë¡œ **XCom**ì´ë¼ëŠ” ê·¸ë£¹ í†µì‹  ë ˆì´ì–´ë¥¼ ì‚¬ìš©í•˜ë©°,
ì´ëŠ” **Paxos ê³„ì—´ í•©ì˜ ì•Œê³ ë¦¬ì¦˜ ê¸°ë°˜**ì…ë‹ˆë‹¤.

### **íŠ¹ì§•**

- íŠ¸ëœì­ì…˜ ì»¤ë°‹ ì „, ê·¸ë£¹ ê³¼ë°˜ìˆ˜ í•©ì˜ë¥¼ ê±°ì¹¨
- ë©¤ë²„ ìƒíƒœ ë³€ê²½ë„ í•©ì˜ ê¸°ë°˜ìœ¼ë¡œ ê²°ì •
- ë„¤íŠ¸ì›Œí¬ ë¶„í•  ì‹œ ê³¼ë°˜ í™•ë³´ ê·¸ë£¹ë§Œ í´ëŸ¬ìŠ¤í„° ìœ ì§€

ì¦‰,

> ë‹¨ìˆœ ë³µì œê°€ ì•„ë‹ˆë¼
â€œíŠ¸ëœì­ì…˜ê³¼ ë©¤ë²„ ìƒíƒœë¥¼ ê·¸ë£¹ ë‹¨ìœ„ë¡œ í•©ì˜í•˜ì—¬ í™•ì •í•˜ëŠ” êµ¬ì¡°â€ ì…ë‹ˆë‹¤.
> 

---

## **3. í´ëŸ¬ìŠ¤í„° êµ¬ì„± ì ˆì°¨**

### **Step 1. ì´ˆê¸°í™”**

```bash
docker compose down -v
docker compose up -d
```

- ë³¼ë¥¨ê¹Œì§€ ì‚­ì œí•˜ì—¬ ì™„ì „ ì´ˆê¸° ìƒíƒœë¡œ ì‹œì‘
- InnoDB Cluster ë©”íƒ€ë°ì´í„° ì´ˆê¸°í™” ëª©ì 

---

### **Step 2. ë°ì´í„° ì ì¬ (Cluster êµ¬ì„± ì „)**

Cluster êµ¬ì„± ì „ì— **mysql1(Seed)** ì— ë¨¼ì € ë°ì´í„° ì ì¬

### **ìˆ˜í–‰ ì‘ì—…**

- card_db ìƒì„±
- CARD_TRANSACTION í…Œì´ë¸” ìƒì„±
- ë³µí•© PK ì„¤ì •

```sql
PRIMARY KEY (BAS_YH, SEQ)
```

- ì•½ 500ë§Œ ê±´ ë°ì´í„° ì ì¬

### **ì„¤ê³„ ì˜ë„**

- 4ëŒ€ ê°ê° ë¡œë”©í•˜ì§€ ì•ŠìŒ
- 1ëŒ€(Seed)ì—ë§Œ ë¡œë”©
- ì´í›„ clone ë°©ì‹ìœ¼ë¡œ ìë™ ë³µì œ

---

### **Step 3. Cluster êµ¬ì„± (mysqlsh + AdminAPI)**

```jsx
dba.configureInstance()
dba.createCluster('wooriCardCluster')
cluster.addInstance(..., { recoveryMethod: 'clone' })
```

- ëª¨ë“  ì¸ìŠ¤í„´ìŠ¤ë¥¼ GR ìš”êµ¬ì‚¬í•­ì— ë§ê²Œ êµ¬ì„±
- mysql1ì„ Seedë¡œ í´ëŸ¬ìŠ¤í„° ìƒì„±
- mysql2/3/4ë¥¼ clone ë°©ì‹ìœ¼ë¡œ ìë™ ë™ê¸°í™”

---

### **Step 4. Router ë¶€íŠ¸ìŠ¤íŠ¸ë©**

```bash
mysqlrouter --bootstrap root@mysql1:3306 ...
```

Routerê°€:

- í´ëŸ¬ìŠ¤í„° ë©”íƒ€ë°ì´í„° ì¡°íšŒ
- ì„¤ì • íŒŒì¼ ìë™ ìƒì„±
- 6446(R/W) / 6447(R/O) í¬íŠ¸ ìƒì„±

---

### **Step 5. ê²€ì¦**

```sql
SELECT COUNT(*) FROM CARD_TRANSACTION;
```

- Secondary(mysql2~4)ì—ì„œ row ìˆ˜ ë™ì¼ í™•ì¸
- clone ë° replication ì •ìƒ ì—¬ë¶€ ê²€ì¦

---

## **4. Failover Test (Primary ì¥ì•  ì‹œ ìë™ ìŠ¹ê²© í…ŒìŠ¤íŠ¸)**

InnoDB Clusterì˜ í•µì‹¬ ê¸°ëŠ¥ ì¤‘ í•˜ë‚˜ëŠ”
**Primary ì¥ì•  ë°œìƒ ì‹œ ìë™ìœ¼ë¡œ Secondaryê°€ ìŠ¹ê²©ë˜ëŠ”ì§€ ì—¬ë¶€**ì…ë‹ˆë‹¤.

ì•„ë˜ëŠ” ì‹¤ì œ í…ŒìŠ¤íŠ¸ ì ˆì°¨ì…ë‹ˆë‹¤.

---

### **4-1. í˜„ì¬ Primary í™•ì¸**

```sql
cluster.status()
```

ì˜ˆì‹œ ì¶œë ¥:

```json
"primary": "mysql1:3306"
```

â†’ í˜„ì¬ Primaryê°€ mysql1ì„ì„ í™•ì¸

---

### **4-2. Primary ê°•ì œ ì¤‘ì§€ (ì¥ì•  ì‹œë®¬ë ˆì´ì…˜)**

```bash
docker stop woori-card-scope-mysql1
```

- Primary(mysql1)ë¥¼ ê°•ì œë¡œ ì¤‘ë‹¨
- ì‹¤ì œ ìš´ì˜ í™˜ê²½ì—ì„œì˜ ì¥ì•  ìƒí™©ì„ ê°€ì •

---

### **4-3. Failover ëŒ€ê¸°**

```bash
sleep 15
```

- Group Replicationì´ ì¥ì• ë¥¼ ê°ì§€í•˜ê³ 
- ìƒˆë¡œìš´ Primaryë¥¼ ì„ ì¶œí•  ì‹œê°„ì„ í™•ë³´

(ì¼ë°˜ì ìœ¼ë¡œ ìˆ˜ ì´ˆ ~ 10ì´ˆ ë‚´ì— ìë™ ì„ ì¶œë¨)

---

### **4-4. ìƒˆë¡œìš´ Primary í™•ì¸**

```bash
docker exec -it woori-card-scope-mysqlsh \
mysqlsh root@mysql2:3306 -- \
cluster status
```

ì˜ˆì‹œ ì¶œë ¥:

```json
"primary": "mysql2:3306"
```

â†’ mysql2ê°€ ìƒˆë¡œìš´ Primaryë¡œ ìŠ¹ê²©ë¨ í™•ì¸

ë˜ëŠ” Routerë¥¼ í†µí•´ í™•ì¸:

```sql
SELECT @@hostname;
```

---

## **4-5. ê¸°ì¡´ Primary ë³µêµ¬**

```bash
docker start woori-card-scope-mysql1
```

- mysql1 ì¬ê¸°ë™
- ìë™ìœ¼ë¡œ Secondaryë¡œ í´ëŸ¬ìŠ¤í„°ì— ì¬í•©ë¥˜

ìƒíƒœ í™•ì¸ í›„ ì˜ˆì‹œ ì¶œë ¥

```sql
"mysql1:3306": {
  "mode": "R/O",
  "status": "ONLINE"
}
```
